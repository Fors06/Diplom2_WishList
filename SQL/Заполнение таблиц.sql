USE SupportManager;
GO

-- Заполнение таблицы ролей сотрудников
INSERT INTO EmployeeRoles (Id, Name, Description) VALUES
(0, 'Программист', 'Разработчик, отвечающий за исправление ошибок и реализацию функционала'),
(1, 'Менеджер', 'Сотрудник, работающий с клиентами и управляющий задачами'),
(2, 'Администратор', 'Администратор системы с полными правами доступа');
GO

-- Заполнение таблицы статусов задач
INSERT INTO TaskStatuses (Id, Name, Description) VALUES
(0, 'Новая', 'Задача создана, но еще не взята в работу'),
(1, 'В работе', 'Задача находится в процессе выполнения'),
(2, 'На проверке', 'Задача выполнена, требуется проверка менеджером'),
(3, 'Завершена', 'Задача успешно завершена и принята'),
(4, 'Отложена', 'Выполнение задачи приостановлено'),
(5, 'Отменена', 'Задача отменена');
GO

-- Заполнение таблицы приоритетов задач
INSERT INTO TaskPriorities (Id, Name, Description) VALUES
(1, 'Низкий', 'Не срочная задача, можно выполнить в течение недели'),
(2, 'Средний', 'Обычный приоритет, выполнить в течение 3-4 дней'),
(3, 'Высокий', 'Срочная задача, требует решения в течение 1-2 дней'),
(4, 'Критический', 'Требуется немедленное решение, блокирует работу');
GO

-- Заполнение таблицы сотрудников
INSERT INTO Employees (FirstName, LastName, Email, PasswordHash, RoleId, IsActive) VALUES
('Иван', 'Петров', 'ivan.petrov@company.com', 'AQAAAAIAAYagAAAAENd2s2r7WQKdTQnR3X6L7VZzM8JkLp1qT2B8C9D0E1F4G5H6I7J8K9L0M1N2O3P', 2, 1),      -- Администратор
('Мария', 'Сидорова', 'maria.sidorova@company.com', 'AQAAAAIAAYagAAAAENd2s2r7WQKdTQnR3X6L7VZzM8JkLp1qT2B8C9D0E1F4G5H6I7J8K9L0M1N2O3P', 1, 1), -- Менеджер
('Алексей', 'Козлов', 'alexey.kozlov@company.com', 'AQAAAAIAAYagAAAAENd2s2r7WQKdTQnR3X6L7VZzM8JkLp1qT2B8C9D0E1F4G5H6I7J8K9L0M1N2O3P', 0, 1),  -- Программист
('Елена', 'Новикова', 'elena.novikova@company.com', 'AQAAAAIAAYagAAAAENd2s2r7WQKdTQnR3X6L7VZzM8JkLp1qT2B8C9D0E1F4G5H6I7J8K9L0M1N2O3P', 1, 1), -- Менеджер
('Дмитрий', 'Васильев', 'dmitry.vasilev@company.com', 'AQAAAAIAAYagAAAAENd2s2r7WQKdTQnR3X6L7VZzM8JkLp1qT2B8C9D0E1F4G5H6I7J8K9L0M1N2O3P', 0, 1),-- Программист
('Анна', 'Морозова', 'anna.morozova@company.com', 'AQAAAAIAAYagAAAAENd2s2r7WQKdTQnR3X6L7VZzM8JkLp1qT2B8C9D0E1F4G5H6I7J8K9L0M1N2O3P', 2, 0);   -- Неактивный администратор
GO

-- Заполнение таблицы клиентов
INSERT INTO Clients (CompanyName, ContactPerson, Email, Phone, Address) VALUES
('ООО "ТехноПром"', 'Сергей Иванов', 'tech@technoprom.ru', '+7-495-123-45-67', 'г. Москва, ул. Ленина, д. 15'),
('ИП "Вектор"', 'Ольга Смирнова', 'info@vector-ip.ru', '+7-812-987-65-43', 'г. Санкт-Петербург, Невский пр-т, д. 100'),
('АО "СтройГарант"', 'Андрей Павлов', 'pavlov@stroigarant.ru', '+7-343-456-78-90', 'г. Екатеринбург, ул. Малышева, д. 45'),
('ООО "ИТ Сервис"', 'Денис Комаров', 'denis@itservice.com', '+7-383-234-56-78', 'г. Новосибирск, ул. Кирова, д. 32'),
('ЗАО "ТрансЛогистик"', 'Наталья Орлова', 'orlova@translogistic.ru', '+7-861-345-67-89', 'г. Краснодар, ул. Красная, д. 120'),
('ООО "МедТех"', 'Артем Белов', 'belov@medtech.org', '+7-351-876-54-32', 'г. Челябинск, пр-т Ленина, д. 76'),
('ООО "Ромашка"', 'Ирина Петренко', 'petrenko@romashka.ru', '+7-401-123-45-67', 'г. Калининград, ул. Гагарина, д. 25'),
('АО "ЭнергоСистемы"', 'Владимир Семенов', 'semenov@energosys.ru', '+7-484-234-56-78', 'г. Калуга, ул. Московская, д. 78');
GO

-- Заполнение таблицы категорий задач
INSERT INTO TaskCategories (Name, Description) VALUES
('Ошибка в системе', 'Ошибки, баги и сбои в работе программного обеспечения'),
('Новый функционал', 'Разработка и внедрение нового функционала по запросу клиента'),
('Доработка', 'Улучшение и оптимизация существующего функционала'),
('Техническая поддержка', 'Консультации, настройка и техническая помощь пользователям'),
('Интеграция', 'Интеграция с внешними системами и API'),
('Отчетность', 'Формирование отчетов, аналитика и статистика'),
('Производительность', 'Проблемы и улучшения производительности системы'),
('Безопасность', 'Вопросы безопасности и доступов');
GO

-- Заполнение таблицы задач
INSERT INTO Tasks (Title, Description, ClientId, CategoryId, ManagerId, ProgrammerId, StatusId, PriorityId, DueDate, EstimatedHours, ActualHours) VALUES
('Не загружаются отчеты за последний месяц', 'Клиент сообщает, что при попытке загрузить отчет за последний месяц система выдает ошибку 500. Проблема воспроизводится постоянно.', 1, 1, 2, 3, 1, 3, DATEADD(DAY, 3, GETDATE()), 8.5, 2.5),
('Добавить экспорт данных в Excel', 'Требуется добавить возможность экспорта табличных данных в формате XLSX с сохранением форматирования.', 2, 2, 2, 5, 0, 2, DATEADD(DAY, 7, GETDATE()), 12.0, NULL),
('Оптимизация медленных запросов в БД', 'Замедление работы системы при работе с большими объемами данных. Необходимо проанализировать и оптимизировать запросы.', 3, 7, 4, 3, 1, 2, DATEADD(DAY, 5, GETDATE()), 16.5, 8.0),
('Проблема с авторизацией пользователей', 'Некоторые пользователи не могут войти в систему с корректными учетными данными. Ошибка возникает случайным образом.', 4, 1, 4, 5, 3, 3, DATEADD(DAY, -1, GETDATE()), 6.0, 7.5),
('Интеграция с системой 1С:Предприятие', 'Настройка двустороннего обмена данными с системой 1С:Предприятие 8.3', 5, 5, 2, 3, 0, 1, DATEADD(DAY, 14, GETDATE()), 24.0, NULL),
('Реализация смс-оповещений для клиентов', 'Реализовать отправку смс-уведомлений клиентам о важных событиях в системе.', 6, 2, 4, 5, 1, 2, DATEADD(DAY, 10, GETDATE()), 20.0, 12.0),
('Исправить расчеты в финансовом отчете', 'Неверные расчеты в финансовом отчете за квартал. Обнаружена ошибка в формуле округления.', 1, 1, 2, 3, 0, 3, DATEADD(DAY, 2, GETDATE()), 4.0, NULL),
('Обновление пользовательского интерфейса', 'Улучшить пользовательский интерфейс в разделе настроек согласно новому дизайну.', 2, 3, 4, 5, 1, 1, DATEADD(DAY, 8, GETDATE()), 10.0, 3.5),
('Настройка резервного копирования', 'Настроить автоматическое ежедневное резервное копирование базы данных.', 7, 4, 2, NULL, 0, 2, DATEADD(DAY, 5, GETDATE()), 5.0, NULL),
('Обновление сертификатов безопасности', 'Обновить SSL сертификаты и настроить политики безопасности.', 8, 8, 4, NULL, 4, 3, DATEADD(DAY, 2, GETDATE()), 8.0, NULL);
GO

-- Обновление даты выполнения для завершенной задачи
UPDATE Tasks SET CompletedDate = DATEADD(HOUR, -5, GETDATE()) WHERE Id = 4;
GO

-- Заполнение таблицы прогресса задач
INSERT INTO TaskProgress (TaskId, EmployeeId, Description, ProgressPercentage, HoursSpent) VALUES
(1, 3, 'Проанализировал логи ошибки. Обнаружена проблема с SQL запросом при формировании отчета за определенный период. Начинаю исправление.', 30, 1.5),
(1, 3, 'Исправил SQL запрос, оптимизировал работу с датами. Добавил обработку исключений. Готовлю тестовые данные для проверки.', 70, 1.0),
(2, 5, 'Изучил требования к экспорту в Excel. Подобрал библиотеку EPPlus для работы с XLSX файлами. Начинаю разработку.', 10, 2.0),
(3, 3, 'Проанализировал медленные запросы с помощью SQL Profiler. Добавил недостающие индексы в таблицы Orders и Reports. Провожу тестирование производительности.', 50, 6.0),
(3, 3, 'Оптимизировал 3 самых медленных запроса. Ускорил выполнение на 40%. Продолжаю работу над остальными запросами.', 75, 2.0),
(4, 5, 'Обнаружил проблему с кодировкой паролей при определенных настройках сервера. Исправил алгоритм хеширования.', 90, 4.0),
(4, 5, 'Проблема решена. Протестировал авторизацию с разных устройств и браузеров. Все работает корректно. Готово к проверке.', 100, 3.5),
(6, 5, 'Выбрал провайдера смс-услуг (SMS Aero). Настроил API для отправки сообщений. Начинаю интеграцию с нашей системой.', 40, 8.0),
(6, 5, 'Реализовал базовую функциональность отправки смс. Добавил очередь сообщений. Начинаю тестирование.', 60, 4.0),
(7, 3, 'Проанализировал формулу расчета в финансовом отчете. Обнаружил ошибку в округлении десятичных чисел.', 20, 1.0),
(8, 5, 'Разработал макет нового интерфейса согласно предоставленному дизайну. Согласовал с менеджером. Приступаю к реализации.', 25, 3.5),
(9, 2, 'Проанализировал требования к резервному копированию. Подготовил план работ. Ожидаю назначения программиста.', 5, 0.5),
(10, 4, 'Получил новые SSL сертификаты. Изучил документацию по обновлению. Ожидаю согласования времени для работ.', 10, 1.0);
GO

-- Заполнение таблицы планов работ
INSERT INTO WorkPlans (TaskId, PlanDescription, TestSteps, EstimatedHours) VALUES
(1, '1. Анализ логов и идентификация ошибки
2. Поиск проблемного кода в модуле отчетности
3. Исправление SQL запроса формирования отчета
4. Добавление валидации входных параметров
5. Тестирование с различными периодами и данными
6. Развертывание исправления на тестовом сервере
7. Проверка клиентом и фиксация решения', 
'1. Создать тестовые данные за разные периоды (месяц, квартал, год)
2. Попытаться сгенерировать отчет за последний месяц
3. Проверить отчет за предыдущие периоды
4. Проверить обработку пустых данных
5. Проверить производительность при больших объемах данных
6. Проверить корректность вычислений в отчете', 8.5),

(2, '1. Выбор и настройка библиотеки для работы с Excel (EPPlus)
2. Разработка функции экспорта табличных данных
3. Реализация сохранения форматирования и стилей
4. Добавление кнопки экспорта в пользовательский интерфейс
5. Настройка обработки больших объемов данных
6. Тестирование функционала экспорта
7. Создание документации для пользователей',
'1. Экспорт пустой таблицы
2. Экспорт таблицы с данными разных типов (текст, числа, даты)
3. Проверка форматирования в полученном Excel файле
4. Проверка работы с большими объемами данных (10k+ строк)
5. Проверка корректности экспортируемых данных
6. Тестирование на разных версиях Excel', 12.0),

(3, '1. Анализ медленных запросов с помощью мониторинга
2. Добавление недостающих индексов в ключевые таблицы
3. Оптимизация сложных JOIN запросов
4. Настройка кэширования часто запрашиваемых данных
5. Рефакторинг проблемного кода
6. Мониторинг производительности после оптимизации
7. Настройка репликации для распределения нагрузки',
'1. Замер времени выполнения ключевых запросов до оптимизации
2. Проверка использования индексов через Execution Plan
3. Нагрузочное тестирование с имитацией реальной нагрузки
4. Мониторинг использования памяти и CPU
5. Проверка стабильности при пиковых нагрузках
6. Сравнение производительности до и после оптимизации', 16.5),

(5, '1. Анализ API системы 1С:Предприятие
2. Разработка модуля обмена данными
3. Настройка форматов данных (XML/JSON)
4. Реализация механизма синхронизации
5. Тестирование обмена в тестовой среде
6. Настройка обработки ошибок и повторов
7. Внедрение в промышленную эксплуатацию',
'1. Тестирование выгрузки данных из нашей системы в 1С
2. Тестирование загрузки данных из 1С в нашу систему
3. Проверка обработки конфликтующих данных
4. Тестирование производительности при больших объемах
5. Проверка корректности преобразования форматов
6. Тестирование восстановления после сбоев', 24.0),

(6, '1. Выбор и регистрация у смс-провайдера
2. Изучение API провайдера и настройка доступа
3. Разработка сервиса отправки смс-сообщений
4. Создание интерфейса управления шаблонами сообщений
5. Реализация очереди сообщений для асинхронной отправки
6. Настройка логирования и мониторинга доставки
7. Интеграция с системой событий для автоматической отправки',
'1. Отправка тестового сообщения на разные номера
2. Проверка доставки на операторы МТС, Билайн, Мегафон, Теле2
3. Тестирование кириллицы в сообщениях
4. Проверка обработки ошибок (недостаточно средств, неверный номер)
5. Нагрузочное тестирование очереди сообщений
6. Проверка форматов и ограничений сообщений', 20.0);
GO

-- Проверка заполненных данных
SELECT 'EmployeeRoles' as TableName, COUNT(*) as Count FROM EmployeeRoles
UNION ALL SELECT 'TaskStatuses', COUNT(*) FROM TaskStatuses
UNION ALL SELECT 'TaskPriorities', COUNT(*) FROM TaskPriorities
UNION ALL SELECT 'Employees', COUNT(*) FROM Employees
UNION ALL SELECT 'Clients', COUNT(*) FROM Clients
UNION ALL SELECT 'TaskCategories', COUNT(*) FROM TaskCategories
UNION ALL SELECT 'Tasks', COUNT(*) FROM Tasks
UNION ALL SELECT 'TaskProgress', COUNT(*) FROM TaskProgress
UNION ALL SELECT 'WorkPlans', COUNT(*) FROM WorkPlans;
GO

-- Пример запроса для просмотра активных задач с детальной информацией
SELECT 
    t.Id as TaskId,
    t.Title,
    c.CompanyName as Client,
    cat.Name as Category,
    m.FirstName + ' ' + m.LastName as Manager,
    p.FirstName + ' ' + p.LastName as Programmer,
    ts.Name as Status,
    tp.Name as Priority,
    t.EstimatedHours,
    t.ActualHours,
    t.DueDate,
    (SELECT TOP 1 ProgressPercentage FROM TaskProgress WHERE TaskId = t.Id ORDER BY CreatedDate DESC) as CurrentProgress
FROM Tasks t
    INNER JOIN Clients c ON t.ClientId = c.Id
    INNER JOIN TaskCategories cat ON t.CategoryId = cat.Id
    INNER JOIN Employees m ON t.ManagerId = m.Id
    LEFT JOIN Employees p ON t.ProgrammerId = p.Id
    INNER JOIN TaskStatuses ts ON t.StatusId = ts.Id
    INNER JOIN TaskPriorities tp ON t.PriorityId = tp.Id
WHERE t.StatusId IN (0, 1) -- Новые и в работе
ORDER BY tp.Id DESC, t.DueDate;
GO

-- Пример запроса для статистики по задачам
SELECT 
    ts.Name as Status,
    COUNT(*) as TaskCount,
    AVG(ISNULL(t.ActualHours, 0)) as AvgActualHours
FROM Tasks t
    INNER JOIN TaskStatuses ts ON t.StatusId = ts.Id
GROUP BY ts.Id, ts.Name
ORDER BY ts.Id;
GO